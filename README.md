# PainterI2V-up WAN2.2 LatentMotion Enhancer by paicat1

本节点受到动画小子大佬（GitHub：[princepainter](https://github.com/princepainter)）开发的 PainterI2V 节点（项目地址：[https://github.com/princepainter/ComfyUI-PainterI2V](https://github.com/princepainter/ComfyUI-PainterI2V)）的启发，是在其基础上进行的后续开发工作。

动画小子大佬的 PainterI2V 节点开创性地完成了潜空间中强化帧间动态的重要工作，有效解决了 Wan2.2 模型配合 4 步 LoRA（如 lightx2v）时的慢动作问题，为图生视频的动态效果提升奠定了关键基础。

本节点在继承其核心思路的前提下，进一步探索了潜空间中运动优化的可能性，针对运动幅度、连贯性及场景适应性等方面进行了深化调整，旨在为图生视频任务提供更精细、更符合实际需求的动态效果控制。

> 专为 WAN2.2 优化的图生视频潜空间运动强化节点，解决传统 I2V 运动僵硬、场景适配差、细节缺失等问题，通过潜空间直接调控运动信息，实现更自然、可控的视频生成效果。
> 作者：paicat1（GitHub：[paicat1](https://github.com/paicat1)）

## 核心亮点
- **WAN2.2 深度适配**：针对 WAN2.2 模型特性优化，完美兼容其图生视频工作流，避免版本兼容问题。
- **潜空间运动强化**：核心基于 `LatentMotion` 技术，在低维潜空间直接调控运动幅度、动态细节，计算高效且效果精准。
- **多维度可控性**：支持分区域运动增强、场景自适应噪声注入、动态模糊调节，满足不同创作需求。
- **场景智能适配**：手动/自动场景匹配（动态主体/自然细节），绕开 prompt 提取误差，适配更多使用场景。

## 安装说明
1. 下载本节点代码文件（建议命名为 `PainterI2V-up_WAN2.2_LatentMotion_Enhancer_by_paicat1.py`）。
2. 将文件复制到 ComfyUI 的 `custom_nodes` 目录下。
3. 重启 ComfyUI，节点将自动加载，在 `Wan Video/Experimental` 分类中可找到。

## 核心功能
| 功能模块 | 作用说明 |
|----------|----------|
| 潜空间运动幅度增强 | 直接在潜空间放大运动差异，提升视频动态感，同时保护画面亮度稳定。 |
| 分区域运动强化 | 基于运动掩码或自动检测，针对性增强主体（人物/动物）或环境细节的运动效果。 |
| 场景自适应噪声 | 根据场景类型（动态主体/自然细节）匹配不同频率噪声，优化动态细节表现。 |
| 时间平滑与动态模糊 | 减少帧间抖动，模拟真实运动模糊，提升视频流畅度。 |
| 2倍 latent 上采样 | 输出原始尺寸与2倍放大双 latent，适配不同分辨率生成需求。 |

## 参数说明
### 必填参数
| 参数名 | 类型 | 默认值 | 范围 | 用途说明 |
|--------|------|--------|------|----------|
| positive | CONDITIONING | - | - | 正向提示词条件，控制视频内容风格与主体。 |
| negative | CONDITIONING | - | - | 反向提示词条件，过滤不需要的画面元素。 |
| vae | VAE | - | - | 用于图像与潜空间的编码转换，建议使用与 WAN2.2 配套的 VAE。 |
| width / height | INT | 832 / 480 | 16-4096（步长16） | 生成视频的宽高，需符合 WAN2.2 模型输入要求。 |
| length | INT | 81 | 1-4096（步长4） | 视频帧数，步长4适配 WAN2.2 模型的时序处理逻辑。 |
| batch_size | INT | 1 | 1-4096 | 批量生成数量，根据显卡显存调整。 |
| motion_amplitude | FLOAT | 1.15 | 1.0-2.0（步长0.05） | 整体运动幅度增强系数，数值越大动态感越强。 |

### 场景与噪声参数
| 参数名 | 类型 | 默认值 | 选项/范围 | 用途说明 |
|--------|------|--------|-----------|----------|
| manual_scene | COMBO | 自动匹配 | 自动匹配/动态主体（人物/动物）/自然细节（风景/纹理） | 手动指定场景类型，提升噪声与运动适配精度。 |
| noise_target | COMBO | 全局（含环境） | 全局（含环境）/仅动作动态/仅环境细节 | 控制噪声注入的目标区域，精准优化动态细节。 |
| noise_strength | FLOAT | 0.0 | 0.0-0.5（步长0.01） | 噪声注入强度，增加画面动态细节（建议0.05-0.2）。 |
| noise_decay_rate | FLOAT | 0.8 | 0.5-1.0（步长0.05） | 噪声随时间衰减系数，避免后期画面混乱。 |

### 进阶控制参数
| 参数名 | 类型 | 默认值 | 范围 | 用途说明 |
|--------|------|--------|------|----------|
| motion_threshold | FLOAT | 0.3 | 0.1-1.0（步长0.05） | 运动掩码生成阈值，数值越小检测到的运动区域越广。 |
| action_amplitude_boost | FLOAT | 1.0 | 1.0-2.0（步长0.1） | 运动区域增强系数，针对性放大主体运动幅度。 |
| time_smooth_strength | FLOAT | 0.0 | 0.0-0.5（步长0.05） | 帧间平滑强度，减少画面抖动（建议0.1-0.3）。 |
| motion_blur_strength | FLOAT | 0.0 | 0.0-0.3（步长0.05） | 动态模糊强度，模拟真实运动轨迹（建议0.05-0.15）。 |

### 可选输入
| 参数名 | 类型 | 用途说明 |
|--------|------|----------|
| clip_vision_output | CLIP_VISION_OUTPUT | 输入 CLIP 视觉特征，增强内容与提示词的对齐度。 |
| start_image | IMAGE | 核心输入！图生视频的起始帧（必填，否则报错）。 |
| motion_mask | MASK | 自定义运动区域掩码，仅增强掩码覆盖区域的运动。 |
| keyframe_image | IMAGE | 关键帧图像，可用于强化特定帧的内容特征。 |
| keyframe_frame_idx | INT | 关键帧在序列中的位置（适配 length 调整）。 |

## 使用示例
1. 准备 `start_image`（起始帧图像）、`VAE`（与 WAN2.2 配套）。
2. 连接 `positive`/`negative` 提示词节点，设置视频宽高、帧数。
3. 根据场景类型选择 `manual_scene`（如“动态主体”用于人物视频）。
4. 调整 `motion_amplitude`（建议1.1-1.3）和 `noise_strength`（建议0.05-0.15）。
5. 输出 `positive`/`negative` 连接到 WAN2.2 生成节点，`samples`/`samples_2x_upscale` 作为 latent 输入。

## 注意事项
1. **start_image 必填**：节点依赖起始帧生成运动序列，未提供将直接报错。
2. **WAN2.2 专属**：仅适配 WAN2.2 模型，其他版本可能出现运动异常或兼容性问题。
3. 显存占用：高分辨率（如 1024x768）+ 高帧数（如 200+）需较大显存，建议根据显卡性能调整参数。
4. 调参建议：先固定 `motion_amplitude=1.2`，再根据场景调整噪声和模糊参数，避免参数叠加导致画面混乱。

## 许可证
本节点基于 MIT 许可证开源，可自由使用、修改和分发，保留原作者（动画小子 princepainter、后续开发 paicat1）署名即可。

---
